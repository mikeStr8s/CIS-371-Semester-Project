<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-layout/app-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../movie-element/movie-element.html">

<dom-module id="main-element">
    <!--FIREBASE DATA:
    apiKey: "AIzaSyCFPyInIWk_oKzp50ofc-h4aakBPzIsfq8",
    authDomain: "moviedatabase-f5f54.firebaseapp.com",
    databaseURL: "https://moviedatabase-f5f54.firebaseio.com",
    projectId: "moviedatabase-f5f54",
    storageBucket: "moviedatabase-f5f54.appspot.com",
    messagingSenderId: "924071065259"
    -->

    <template>
        <style include="iron-flex iron-flex-alignment iron-flex-factors"></style>
        <style>
            app-toolbar {
                background-color: #4285f4;
                color: white;
                font-weight: bold;
            }
            #searchBar {
                --paper-input-container-color: white;
                --paper-input-container-focus-color: white;
            }
            :host {
                display: block;
                --app-drawer-width: 40%;
            }
            #sidePanel p{
                padding:10px;
                text-align: left;
            }
        </style>
        <firebase-app auth-domain="moviedatabase-f5f54.firebaseapp.com"
                      database-url="https://moviedatabase-f5f54.firebaseio.com"
                      api-key="AIzaSyCFPyInIWk_oKzp50ofc-h4aakBPzIsfq8"></firebase-app>
        <firebase-auth id="auth" user="{{user}}" provider="google"></firebase-auth>
        <firebase-document
                path="/users/[[user.uid]]"
                data="{{userData}}">
        </firebase-document>
        <app-header reveals effects="waterfall">
            <app-toolbar>
                <div main-title>Movie Reviews</div>
                <paper-input id="searchBar" label="Search"></paper-input>
                <paper-icon-button on-click="queryMovie" icon="search"></paper-icon-button>
                <template is="dom-if" if="[[user]]">
                    <paper-button>[[user.displayName]]</paper-button>
                    <paper-button on-click="logout">Logout</paper-button>
                </template>
                <template is="dom-if" if="[[!user]]">
                    <paper-button on-click="login">Login</paper-button>
                </template>
            </app-toolbar>
        </app-header>
        <div class="layout horizontal">
            <div class="flex-2 layout vertical">
                <!--for some reason we have to use dom-repeat with observe property to re-render
                changes to the movie list array, OR we can just update it to a new array each time we make a change -->
                <template is="dom-repeat" items="{{movieList}}" observe="movieList.*">
                    <movie-element class="flex" movie="{{item}}" on-click="openDetails"></movie-element>
                </template>
            </div>
            <div class="flex-2">
                <!--Side panel-->
                <app-drawer id="sidePanel" align="right">
                    <div class="vertical layout start">
                        <p id="overview"></p>
                        <p id="moviegenres"></p>
                        <p>Your Rating:</p>
                        <div class="horizontal layout self-center">
                            <paper-slider min="0" max="10" value="{{sliderValue}}" snaps></paper-slider>
                            <div id="rating">[[sliderValue]]</div>
                        </div>
                    </div>
                </app-drawer>
            </div>
        </div>
    </template>

    <script>
        /**
         * @customElement
         * @polymer
         */
        class MainElement extends Polymer.Element {
            static get is() {
                return 'main-element';
            }
            static get properties() {
                return {
                    movieList:{
                        type: Array,
                        value:[]
                    },
                    user:{
                        type:Object
                    },
                    userData:{
                        type: Object,
                        observer: 'observeUserData'
                    },
                    sliderValue:{
                        type: Number,
                        value: 5,
                        observer:'sliderChanged'
                    },
                    selectedMovie:{
                        type: Object
                    }
                };
            }
            login(){
                console.log("Logging in");
                this.$.auth.signInWithPopup()
                    .then(function(response){
                        console.log(response);
                    }.bind(this))
                    .catch(function(error){
                        console.log("Error signing in");
                        console.log(error);
                    });
            }
            logout(){
                console.log("Logging out");
                this.$.auth.signOut();
            }
            openDetails(event){
                if(event && event.model && event.model.item){
                    var movie = event.model.item;
                    this.set('selectedMovie', movie);
                    //TODO populate side panel with movie details/user review data

                    var moviegenres = this.$.moviegenres;   //variable for the movie genre element
                    moviegenres.textContent = "";   //clear the text within the element

                    var genreURL = "https://api.themoviedb.org/3/genre/movie/list?api_key=621dd8327c6b6da21938d21e41f1f9da&language=en-US";
                    $.getJSON(genreURL, function (data, status, xhr) {
                        JSON.stringify(data);
                        var genreArray = data['genres'];    //store array of genres and their corresponding id's
                        var movieGenres = [];    //array for storing all of the genre names for a given movie
                        for(var i = 0; i < movie['genre_ids'].length; i++){ //for each genre id tied to a movie
                            for(var k = 0; k < genreArray.length; k++){ //for each entry in the genre array
                                if(movie['genre_ids'][i] === genreArray[k]['id']){  //if the movies genre id is the same as one in the genre array
                                    movieGenres.push(genreArray[k]['name']);    //add genre to movie genre array
                                    moviegenres.textContent+= genreArray[k]['name']+ " ";   //set component text to include the genre
                                }
                            }
                        }
                    });

                    var movieOverview = movie['overview'];  //string element for a movies given overview text
                    this.$.overview.textContent = movieOverview;    //set component text to the movie overview

                    this.$.sidePanel.open();
                }
            }
            queryMovie() {
                //Clear existing array to populate with new movies
                this.set('movieList', []);
                var queryURL = "https://api.themoviedb.org/3/search/movie?api_key=621dd8327c6b6da21938d21e41f1f9da&query=" + this.$.searchBar.value;
                $.getJSON(queryURL, function (data, status, xhr) {
                    for(var i = 0; i < data.results.length; i++){
                        var movie = data.results[i];
                        movie.poster_path = `http://image.tmdb.org/t/p/w92${movie.poster_path}`;
                        //We have to use Polymer push method with observable arrays :(
                        this.push('movieList',movie);
                    }
                }.bind(this)).fail(function () {
                    console.log("no movies");
                })
            }
            sliderChanged(newVal){
                if(this.userData.movieReviews){
                    var movieReview = this.userData.movieReviews[this.selectedMovie.id];
                    if(movieReview){
                        //Update existing rating
                        this.set(`userData.movieReviews.${this.selectedMovie.id}.rating`, newVal);
                    }else{
                        //Set new rating
                        this.set(`userData.movieReviews.${this.selectedMovie.id}`, {rating: newVal});
                    }
                }
            }
            observeUserData(newVal){
                if(Object.keys(newVal) <= 0){
                    //Initialize user data if empty object
                    this.set('userData',new UserData());
                }
                console.log(newVal);
            }
        }

        window.customElements.define(MainElement.is, MainElement);
    </script>
</dom-module>
